<!doctype html>
<title>Zillow Vis</title>

<!-- Import Stylesheets -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
  integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
  crossorigin=""/>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<link rel="stylesheet" href="style.css" />

<!-- Include Leaflet Library AFTER Leaflet's CSS -->
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
 integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
 crossorigin=""></script>
<script src="https://d3js.org/d3.v4.min.js"></script>

<!-- Import Our Custom Scripts -->
<script src="layers.js"></script>
<script src="Search.js"></script>

<body>
  <!-- Layout of Search Engine -->
  <div class="container-fluid">
    <!-- Search Bar Area -->
    <div class="row">
      <div class="col-lg-12" style="background-color: red">
        Hello World
      </div>
    </div>
    <!-- Filters -->
    <div class="row">
      <div class="col-lg-12" style="background-color: white">
        <div class='search_bar'>
          <button type="button" class="btn btn-info">Prices</button>
          <button type="button" class="btn btn-info">Default</button>
          <button type="button" class="btn btn-info">Default</button>
          <button type="button" class="btn btn-info">Default</button>
        </div>
      </div>
    </div>
    <!-- History and Map -->
    <div class="row">
      <!-- Left Column -->
      <!-- <div class="col-lg-3" style="background-color: blue">
        Hello World
      </div> -->
      <div class="col-lg-12">
            <div id="mapid"></div>
      </div>
    </div>
  </div>
</body>

<script>

let mapboxAccessToken = 'pk.eyJ1IjoiamltLXplZC1saSIsImEiOiJjamZjeGVzNzYzY3l4MndwZDJvcGhpNjF2In0.LgHQ5McMsqeSciorxS-RBw'
let geojsonFeature, censusData, zillowData;
let geoJson;
// To hold leaflet's default geoJSON container

d3.queue()
.defer(d3.csv, "./data/census_data.csv")
.defer(d3.json,"./data/allegheny_county_census_tracts_2016.geojson")
.defer(d3.csv, "./data/zillow_pittsburgh.csv")
.await(function(error, f1, f2, f3) {
  if (error) throw error;
  censusData = f1;
  geojsonFeature = f2; //geoJSON.features contain polygons
  zillowData = f3;

  geojsonFeature.features.forEach(function(row) {
    // ensure no missing value from census tract id
    let result = censusData.filter(function(entry) {
      return entry.tract === row.properties.TRACTCE;
    });
    // append census data to geoJSON feature.properties
    row.properties.census = (result[0] !== undefined) ? result[0] : null;
  })

  // lay out base map layout
  let map = L.map('mapid').setView([40.4406, -79.9959], 13);
  L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
      maxZoom: 15,
      minZoom: 12,
      zoomSnap: 0.2,
      id: 'mapbox.light',
      accessToken: mapboxAccessToken
  }).addTo(map);

  /*Custom INfo COntrol on the side*/
  let info = L.control();
  info.onAdd = function(map) {
    this._div = L.DomUtil.create('div', 'info'); //create a div with a class "info"
    this.update();
    return this._div;
  }

  // a function to update the control based on feature properties
  info.update = function(props) {
    this._div.innerHTML = '<h4>Population Density in this region</h4>' + (
      props ? '<b>' + props.census.total_pop + '</b>' : 'Hover over a place');
  };

  info.addTo(map);

  /* Zooming on click feature */
  let highlightFeature = function(e) {
    let layer = e.target;
    layer.setStyle({
      weight: 5,
      color: '#666',
      dashArray: '',
      fillOpacity: 0.7
    });
    info.update(layer.feature.properties);
  }

  let resetHighlight = function(e) {
    geoJson.resetStyle(e.target); //geoJson has to be declared first
    info.update();
  }

  let zoomToFeature = function(e) {
    map.fitBounds(e.target.getBounds()); //map has to be declared first
  }

  let onEachFeature = function(feature, layer) {
    layer.on({
      mouseover: highlightFeature,
      mouseout: resetHighlight,
      click: zoomToFeature
    });
  }

  /*Population choropleth*/
  let populationExtent = d3.extent(geojsonFeature.features, function(d) {
      if (d.properties.census) {
          return Number(d.properties.census.total_pop)
      }
  })

  let populationColorScheme = function(d) {
      return d > 10000 ? '#800026' :
             d > 5000  ? '#BD0026' :
             d > 2000  ? '#E31A1C' :
             d > 1000  ? '#FC4E2A' :
             d > 500   ? '#FD8D3C' :
             d > 200   ? '#FEB24C' :
             d > 100   ? '#FED976' :
                        '#FFEDA0';
    }

  let populationMapLayer = function(feature) {
    return {
        fillColor: populationColorScheme((feature.properties.census !== null) ? Number(feature.properties.census.total_pop) : 0),
        weight: 1,
        opacity: 0.5,
        color: 'white',
        dashArray: '3',
        fillOpacity: 0.4
    };
  }

  // add allegheny county census tract boundaries
  geoJson = L.geoJSON(geojsonFeature, {
    style: populationMapLayer,
    onEachFeature: onEachFeature
  }).addTo(map);

  show_houses(zillowData, map);
  filter_by_prices(zillowData, 1000);

});

</script>
